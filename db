#!/bin/bash

DB_NAME="$1";

# ===== Table Menu =====
function Menu {
  while true; do
    option=$(zenity --list \
      --title="Connected to Database: $DB_NAME" \
      --column="Options" \
      "Create Table" \
      "List Tables" \
      "Drop Table" \
      "Insert Into Table" \
      "Select From Table" \
      "Delete From Table" \
      "Update Table" \
      "Back to Main Menu"\
      "Exit")

    case $option in
      "Create Table") createTable ;;
      "List Tables") listTables ;;
      "Drop Table") dropTable ;;
      "Insert Into Table") insertTable ;;
      "Select From Table") select_from_table ;;
      "Delete From Table") delete_from_table ;;
      "Update Table") updateTable ;;
      "Back to Main Menu") return ;;
      "Exit")
        exit 0
        ;;
      *)
        if [ $? -eq 1 ]
        then
          zenity --warning --text="Invalid choice, please select again";
        fi
        ;;
    esac
  done
}

# ===== Create Table =====
function createTable {
  while true; do
    table_name=$(zenity --entry --title="Create Table" --text="Enter Table Name ")

    [[ -z "$table_name" ]] && { zenity --warning --text="Table name cannot be empty"; continue; }
    [[ ! "$table_name" =~ ^[A-Za-z][a-zA-Z0-9]*$ ]] && { zenity --warning --text="Table name can contain only letters and numbers"; continue; }

    # Check if table exists (look for metadata)
    existing=$(ls *.metadata 2>/dev/null | grep -i "^$table_name.metadata$")
    [[ -n "$existing" ]] && { zenity --warning --text="Table '$table_name' already exists"; continue; }

    # Create table files
    touch "$table_name.metadata"
    

    # Add automatic id column
    echo "id:int:PK" >> "$table_name.metadata"

    # Add other columns
    cols_num=$(zenity --entry --title="Columns" --text="Enter number of columns:")
    if ! [[ "$cols_num" =~ ^[0-9]+$ ]] || [[ "$cols_num" -lt 1 ]]; then
      zenity --warning --text="Invalid number of columns"
      rm "$table_name.metadata" "$table_name.data"
      continue
    fi

    for ((i=1; i<=cols_num; i++)); do
      col_name=$(zenity --entry --title="Column $i" --text="Enter column name:")
      [[ -z "$col_name" || "$col_name" == "id" ]] && { zenity --warning --text="Invalid column name or 'id' is reserved"; rm "$table_name.metadata" "$table_name.data"; continue 2; }

      col_type=$(zenity --list --title="Column Type for '$col_name'" --column="Type" "int" "string")
      [[ -z "$col_type" ]] && { zenity --warning --text="You must select a data type"; rm "$table_name.metadata" "$table_name.data"; continue 2; }

      echo "$col_name:$col_type" >> "$table_name.metadata"
    done

    zenity --info --text="Table '$table_name' created successfully"
    break
  done
}

# ===== List Tables =====
function listTables {
mapfile -t tables < <(ls *.metadata 2>/dev/null | sed 's/\.metadata$//')

[[ ${#tables[@]} -eq 0 ]] && { zenity --info --text="No tables found"; return; }

zenity --list --title="Tables in $DB_NAME" --column="Table Name" "${tables[@]}"

}

# ===== Drop Table =====
function dropTable {

  # جلب أسماء الجداول (من ملفات metadata)
  mapfile -t tables < <(ls *.metadata 2>/dev/null | sed 's/\.metadata$//')

  # لو مفيش جداول
  if [[ ${#tables[@]} -eq 0 ]]; then
    zenity --info --text="No tables to drop"
    return
  fi

  # عرض الجداول في zenity
  table=$(zenity --list \
    --title="Drop Table" \
    --column="Tables" \
    "${tables[@]}")

  # لو المستخدم ضغط Cancel
  [[ -z "$table" ]] && return

  # تأكيد الحذف
  zenity --question --text="Are you sure you want to drop table '$table'?"
  [[ $? -ne 0 ]] && return

  # حذف ملفات الجدول
  rm -f "$table.metadata" "$table.data"

  # feedback حسب نتيجة الحذف
  feedback $? "Table '$table' dropped successfully" "Failed to drop table '$table'"
}


# ===== Insert Into Table =====
function insertTable {
  # ===== List tables =====
  tables=$(ls *.metadata 2>/dev/null | sed 's/\.metadata$//')
  [[ -z "$tables" ]] && { zenity --info --text="No tables found"; return; }

  table_input=$(zenity --list --title="Insert Into Table" --column="Tables" $tables)
  [[ -z "$table_input" ]] && { zenity --warning --text="No table selected"; return; }

  # Case-insensitive match
  table=$(ls *.metadata | awk -v t="$table_input" 'tolower($0)==tolower(t".metadata")' | sed 's/\.metadata$//')
  meta_file="$table.metadata"
  data_file="$table.data"

  # ===== Write column names if data file is empty =====
  if [[ ! -s "$data_file" ]]; then
    cols="id"
    while IFS=: read -r col_name col_type col_key; do
      [[ "$col_name" == "id" ]] && continue
      cols="$cols:$col_name"
    done < "$meta_file"
    echo "$cols" > "$data_file"
  fi

  # Auto-increment ID (skip header line)
  last_id=$(tail -n +2 "$data_file" | tail -n1 | cut -d':' -f1)
  if [[ -z "$last_id" ]]; then new_id=1; else new_id=$((last_id + 1)); fi
  record="$new_id"

  # Insert based on metadata
  while IFS=: read -r col_name col_type col_key; do
    [[ "$col_name" == "id" ]] && continue
    while true; do
      value=$(zenity --entry --title="Insert Value" --text="Enter value for $col_name ($col_type)")
      [[ -z "$value" ]] && { zenity --warning --text="Value cannot be empty"; continue; }
      if [[ "$col_type" == "int" && ! "$value" =~ ^[0-9]+$ ]]; then
        zenity --warning --text="$col_name must be a number"; continue
      fi
      if [[ "$col_type" == "string" && "$value" == *":"* ]]; then
        zenity --warning --text="':' character is not allowed"; continue
      fi
      record="$record:$value"; break
    done
  done < "$meta_file"

  # Append record
  echo "$record" >> "$data_file"
  zenity --info --text="Record inserted successfully into table '$table'"
}

# ===== Update Table =====
# ===== Update Table =====
function updateTable {

  tables=$(ls *.metadata 2>/dev/null | sed 's/\.metadata$//')
  [[ -z "$tables" ]] && { zenity --info --text="No tables found"; return; }

  table_input=$(zenity --list --title="Update Table" --column="Tables" $tables)
  [[ -z "$table_input" ]] && return

  table="$table_input"
  meta_file="$table.metadata"
  data_file="$table.data"

  [[ ! -s "$data_file" ]] && { zenity --info --text="Table '$table' has no data"; return; }

  # Only numeric IDs (skip header)
  ids=$(tail -n +2 "$data_file" | cut -d':' -f1)
  record_id=$(zenity --list --title="Select Record ID" --column="ID" $ids)
  [[ -z "$record_id" ]] && return

  # Build list of columns
  cols=()
  while IFS=: read -r name type key; do [[ "$name" != "id" ]] && cols+=("$name"); done < "$meta_file"
  col_name=$(zenity --list --title="Select Column to Update" --column="Columns" "${cols[@]}")
  [[ -z "$col_name" ]] && return

  col_type=$(awk -F: -v c="$col_name" '$1==c {print $2}' "$meta_file")
  col_index=$(awk -F: -v c="$col_name" 'BEGIN{idx=0}{idx++} $1==c{print idx}' "$meta_file")

  # Input new value
  while true; do
    new_value=$(zenity --entry --title="Update Value" --text="Enter new value for $col_name ($col_type)")
    [[ -z "$new_value" ]] && { zenity --warning --text="Value cannot be empty"; continue; }
    if [[ "$col_type" == "int" && ! "$new_value" =~ ^[0-9]+$ ]]; then
      zenity --warning --text="$col_name must be a number"; continue
    fi
    if [[ "$col_type" == "string" && "$new_value" == *":"* ]]; then
      zenity --warning --text="':' character is not allowed"; continue
    fi
    break
  done

  # Update the record
  awk -F: -v OFS=: -v id="$record_id" -v idx="$col_index" -v val="$new_value" '
    $1==id {$idx=val} {print}
  ' "$data_file" > "$data_file.tmp" && mv "$data_file.tmp" "$data_file"

  zenity --info --text="Record with ID $record_id updated successfully"
}


# ===== Select from Table =====
# ===== Select from Table =====
function select_from_table {
  while true; do
    # Only get .data files if they exist
    shopt -s nullglob
    data_files=( *.data )
    shopt -u nullglob

    # Strip .data extension
    tables=()
    for f in "${data_files[@]}"; do
      tables+=( "$(basename "$f" .data)" )
    done

    if [ ${#tables[@]} -eq 0 ]; then
      zenity --info --text="No tables found"
      return
    fi

    table_name=$(zenity --list \
      --title="Select Table" \
      --column="Tables" "${tables[@]}")

    [ -z "$table_name" ] && return

    option=$(zenity --list \
      --title="Select Option" \
      --column="Option" \
      "Select All" "Select using Where" "Back")

    case "$option" in
      "Select All") select_all "$table_name.data" ;;
      "Select using Where") select_where "$table_name.data" ;;
      "Back"|"") return ;;
    esac
  done
}


function select_all {
  table="$1"

  if [ ! -s "$table" ]; then
    zenity --info --text="Table is empty"
    return
  fi

  column -t -s ':' "$table" | zenity --text-info \
    --title="Table Data" \
    --width=700 \
    --height=400 \
    --font="monospace"
}

function select_where {
  table="$1"

  while true
  do
    columns=$(head -n 1 "$table")
    IFS=':' read -ra cols <<< "$columns"

    attr=$(zenity --list --title="Select Column" --column="Attributes" "${cols[@]}")
    [ -z "$attr" ] && return

    value=$(zenity --entry --title="Input required" --text="Enter value:")
    [ -z "$value" ] && continue

    col_index=0
    for i in "${!cols[@]}"; do
      if [ "${cols[$i]}" = "$attr" ]; then
        col_index=$((i + 1))
        break
      fi
    done

    awk -F ':' -v col="$col_index" -v val="$value" '
      NR > 1 && $col == val {print}
    ' "$table" |
    column -t -s ':' |
    zenity --text-info \
      --title="Query Result" \
      --width=700 \
      --height=400 \
      --font="monospace"

    return
  done
}


# ===== Delete from Table =====
function delete_from_table {

    mapfile -t tables < <(ls *.metadata 2>/dev/null | sed 's/\.metadata$//')

  # لو مفيش جداول
  if [[ ${#tables[@]} -eq 0 ]]; then
    zenity --info --text="No tables to delete"
    return
  fi

  tables=` ls *.data | sed 's/\.data$//' `
  table_name=` zenity --list --title="Please select an option to start" --column="Tables" $tables `;

  if [ ! -f "$table_name.data" ]
  then
    echo "Table not found";
    return ;
  fi

  columns=$(head -n 1 "$table_name.data");
  IFS=':' read -ra cols <<< "$columns";

  attr=` zenity --list --title="Please select an column to start" --column="Attributes" ${cols[@]} `;
  value=` zenity --entry --title="Input required" --text="Enter value to delete:" `;

  col_index=0;
  for i in "${!cols[@]}"
  do
    if [ "${cols[$i]}" = "$attr" ];
    then
      col_index=$((i + 1));
      break;
    fi
  done

  match=` awk -F ':' -v col="$col_index" -v val="$value" '{ if (NR > 1 && $col == val) print $0; }' "$table_name.data" `;

  if [ -z "$match" ];
  then
    zenity --info --text="No matching records found";
    return;
  fi

  zenity --question --text="Are you sure you want to delete these records?";
  if [ $? -ne 0 ]
  then
    exit 0;
  fi

  awk -F ':' -v col="$col_index" -v val="$value" '
    NR==1 {print; next}
    $col != val {print}
  ' "$table_name.data" > temp.data

  mv temp.data "$table_name.data"

  zenity --info --text="Record(s) deleted successfully!"
}


function choose_db {
  local BASE_DIR=$(pwd)   

  DB_NAME=$(zenity --entry --title="Enter Database Folder" --text="Enter database name")
  [[ -z "$DB_NAME" ]] && return

  if [[ ! -d "$DB_NAME" ]]; then
    zenity --warning --text="Database '$DB_NAME' does not exist"
    return
  fi

  cd "$DB_NAME" || { zenity --error --text="Failed to enter database directory"; return; }
  Menu
  cd "$BASE_DIR"   
}

choose_db
